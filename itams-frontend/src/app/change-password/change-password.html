<!-- Change Password Page - Professional Design -->
<div class="change-password-container d-flex align-items-center justify-content-center min-vh-100">
  <div class="change-password-card">
    <div class="card shadow-lg border-0">
      <div class="card-body p-5">
        <!-- Header -->
        <div class="text-center mb-4">
          <div class="change-password-icon mb-3">
            <i class="fas fa-key text-warning" style="font-size: 3rem;"></i>
          </div>
          <h2 class="fw-bold text-dark mb-2">
            {{ isFirstLogin ? 'Welcome! Set Your Password' : 'Request Password Reset' }}
          </h2>
          <p class="text-muted">
            <span *ngIf="isFirstLogin">This is your first login. Please create a secure password to continue.</span>
            <span *ngIf="!isFirstLogin && isRequired">Request a password reset from your administrator.</span>
            <span *ngIf="!isFirstLogin && !isRequired">Request a password reset from your administrator.</span>
          </p>
        </div>

        <!-- Messages -->
        <div *ngIf="success" class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="fas fa-check-circle me-2"></i>{{ success }}
          <button type="button" class="btn-close" (click)="clearMessages()"></button>
        </div>

        <div *ngIf="error" class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
          <button type="button" class="btn-close" (click)="clearMessages()"></button>
        </div>

        <!-- Required Notice -->
        <div *ngIf="isFirstLogin || isRequired" class="alert alert-info" role="alert">
          <i class="fas fa-info-circle me-2"></i>
          <strong>{{ isFirstLogin ? 'First Login Setup' : 'Password Reset Request' }}</strong>
          <p class="mb-0 mt-1">
            <small *ngIf="isFirstLogin">You must create a new password to complete your account setup.</small>
            <small *ngIf="!isFirstLogin">Click the button below to send a password reset request to your administrator. They will reset your password and notify you.</small>
          </p>
        </div>

        <!-- Change Password Form (only for first login) -->
        <form *ngIf="isFirstLogin" (ngSubmit)="onChangePassword()" #changePasswordForm="ngForm">
          <!-- Current Password (skip for first login) -->
          <div *ngIf="!isFirstLogin" class="mb-3">
            <label for="currentPassword" class="form-label">
              <i class="fas fa-lock me-2"></i>Current Password
            </label>
            <div class="input-group">
              <input
                [type]="showCurrentPassword ? 'text' : 'password'"
                class="form-control form-control-lg"
                id="currentPassword"
                name="currentPassword"
                [(ngModel)]="passwordForm.currentPassword"
                #currentPassword="ngModel"
                required
                [disabled]="loading"
                placeholder="Enter your current password"
                autocomplete="current-password"
              />
              <button
                type="button"
                class="btn btn-outline-secondary"
                (click)="togglePasswordVisibility('current')"
                [disabled]="loading"
              >
                <i [class]="showCurrentPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
              </button>
            </div>
            <div *ngIf="currentPassword.invalid && currentPassword.touched" class="invalid-feedback d-block">
              <div *ngIf="currentPassword.errors?.['required']">Current password is required</div>
            </div>
          </div>

          <!-- New Password -->
          <div class="mb-3">
            <label for="newPassword" class="form-label">
              <i class="fas fa-key me-2"></i>{{ isFirstLogin ? 'Create Password' : 'New Password' }}
            </label>
            <div class="input-group">
              <input
                [type]="showNewPassword ? 'text' : 'password'"
                class="form-control form-control-lg"
                id="newPassword"
                name="newPassword"
                [(ngModel)]="passwordForm.newPassword"
                #newPassword="ngModel"
                required
                [disabled]="loading"
                [placeholder]="isFirstLogin ? 'Create your secure password' : 'Enter your new password'"
                autocomplete="new-password"
                (input)="onNewPasswordInput()"
              />
              <button
                type="button"
                class="btn btn-outline-secondary"
                (click)="togglePasswordVisibility('new')"
                [disabled]="loading"
              >
                <i [class]="showNewPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
              </button>
            </div>
            <div *ngIf="newPassword.invalid && newPassword.touched" class="invalid-feedback d-block">
              <div *ngIf="newPassword.errors?.['required']">{{ isFirstLogin ? 'Password' : 'New password' }} is required</div>
            </div>

            <!-- Password Strength Indicator -->
            <div *ngIf="passwordForm.newPassword" class="mt-2">
              <div class="progress" style="height: 6px;">
                <div
                  class="progress-bar"
                  [class]="'bg-' + passwordStrength.color"
                  [style.width.%]="(passwordStrength.score / 5) * 100"
                ></div>
              </div>
              <small [class]="'text-' + passwordStrength.color + ' fw-bold'">
                {{ passwordStrength.feedback }}
              </small>
            </div>
          </div>

          <!-- Confirm Password -->
          <div class="mb-3">
            <label for="confirmPassword" class="form-label">
              <i class="fas fa-check-double me-2"></i>{{ isFirstLogin ? 'Confirm Password' : 'Confirm New Password' }}
            </label>
            <div class="input-group">
              <input
                [type]="showConfirmPassword ? 'text' : 'password'"
                class="form-control form-control-lg"
                id="confirmPassword"
                name="confirmPassword"
                [(ngModel)]="passwordForm.confirmPassword"
                #confirmPassword="ngModel"
                required
                [disabled]="loading"
                [placeholder]="isFirstLogin ? 'Confirm your password' : 'Confirm your new password'"
                autocomplete="new-password"
                (input)="onConfirmPasswordInput()"
              />
              <button
                type="button"
                class="btn btn-outline-secondary"
                (click)="togglePasswordVisibility('confirm')"
                [disabled]="loading"
              >
                <i [class]="showConfirmPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
              </button>
            </div>
            <div *ngIf="confirmPassword.invalid && confirmPassword.touched" class="invalid-feedback d-block">
              <div *ngIf="confirmPassword.errors?.['required']">Please confirm your {{ isFirstLogin ? '' : 'new ' }}password</div>
            </div>

            <!-- Password Match Indicator -->
            <div *ngIf="passwordForm.confirmPassword" class="mt-1">
              <small [class]="getPasswordMatchStatus()">
                <i [class]="getPasswordMatchIcon() + ' me-1'"></i>
                {{ passwordForm.newPassword === passwordForm.confirmPassword ? 'Passwords match' : 'Passwords do not match' }}
              </small>
            </div>
          </div>

          <!-- Password Requirements (more prominent for first login) -->
          <div class="mb-4" [class.password-requirements]="isFirstLogin">
            <h6 class="text-muted mb-2" [class.fw-bold]="isFirstLogin">
              <i class="fas fa-shield-alt me-2"></i>Password Requirements
              <small *ngIf="!isFirstLogin" class="text-muted">(for security)</small>
            </h6>
            <div class="row" [class.small]="!isFirstLogin">
              <div class="col-md-6" *ngFor="let req of passwordRequirements">
                <div class="d-flex align-items-center mb-1">
                  <i [class]="getRequirementIcon(req) + ' me-2'" [style.font-size]="isFirstLogin ? '1rem' : '0.8rem'"></i>
                  <small [class]="getRequirementClass(req.key)" [style.font-size]="isFirstLogin ? '0.875rem' : '0.75rem'">
                    {{ req.label }}
                  </small>
                </div>
              </div>
            </div>
          </div>

          <!-- Submit Button (inside form for first login) -->
          <div class="d-grid gap-2">
            <button
              type="submit"
              class="btn btn-primary btn-lg"
              [disabled]="loading || changePasswordForm.invalid || passwordStrength.score < 5 || passwordForm.newPassword !== passwordForm.confirmPassword"
            >
              <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
              <i *ngIf="!loading" class="fas fa-key me-2"></i>
              {{ loading ? 'Creating Password...' : 'Create Password' }}
            </button>

            <!-- Logout button for first login -->
            <button
              type="button"
              class="btn btn-outline-danger btn-sm w-100"
              (click)="onLogout()"
              [disabled]="loading"
            >
              <i class="fas fa-sign-out-alt me-2"></i>Logout Instead
            </button>
          </div>
        </form>

        <!-- Password Reset Request Section (for non-first-login users) -->
        <div *ngIf="!isFirstLogin" class="text-center py-4">
          <div class="mb-4">
            <i class="fas fa-user-lock text-warning" style="font-size: 4rem;"></i>
          </div>
          <h5 class="mb-3">Need to Change Your Password?</h5>
          <p class="text-muted mb-4">
            Click the button below to send a password reset request to your Super Admin. 
            <br>
            They will be notified and can reset your password in the User Management section.
            <br>
            <small class="text-info">You can continue using the system while waiting for the reset.</small>
          </p>

          <!-- Action Buttons -->
          <div class="d-grid gap-2">
            <!-- Request Password Reset Button (for regular users who forgot/want to change password) -->
            <button
              type="button"
              class="btn btn-warning btn-lg"
              (click)="onRequestPasswordReset()"
              [disabled]="loading"
            >
              <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
              <i *ngIf="!loading" class="fas fa-envelope me-2"></i>
              {{ loading ? 'Sending Request...' : 'Request Password Reset' }}
            </button>

            <!-- Cancel/Logout buttons (only show if not required) -->
            <div *ngIf="!isRequired" class="d-flex gap-2">
              <button
                type="button"
                class="btn btn-outline-secondary flex-fill"
                (click)="onCancel()"
                [disabled]="loading"
              >
                <i class="fas fa-times me-2"></i>Cancel
              </button>
            </div>

            <!-- Logout button for required password change -->
            <div *ngIf="isRequired">
              <button
                type="button"
                class="btn btn-outline-danger btn-sm w-100"
                (click)="onLogout()"
                [disabled]="loading"
              >
                <i class="fas fa-sign-out-alt me-2"></i>Logout Instead
              </button>
            </div>
          </div>
        </div>

        <!-- Security Notice -->
        <div class="mt-4 pt-3 border-top">
          <div class="text-center">
            <small class="text-muted">
              <i class="fas fa-info-circle me-1"></i>
              Your password will be encrypted and stored securely. 
              <br>
              Session will remain active for {{ authService.settings.sessionTimeoutMinutes }} minutes.
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>