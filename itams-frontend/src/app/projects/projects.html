<!-- Projects Main View - No Scroll Design -->
<div class="projects-container h-100 d-flex flex-column">
  <!-- Header Section -->
  <div class="projects-header d-flex justify-content-between align-items-center p-3 border-bottom">
    <h2 class="mb-0">Project Management</h2>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <i class="fas fa-plus me-2"></i>Create Project
    </button>
  </div>

  <!-- Messages Section -->
  <div class="messages-section" *ngIf="success || error">
    <div *ngIf="success" class="alert alert-success alert-dismissible fade show m-3 mb-0" role="alert">
      {{ success }}
      <button type="button" class="btn-close" (click)="clearMessages()"></button>
    </div>
    <div *ngIf="error" class="alert alert-danger alert-dismissible fade show m-3 mb-0" role="alert">
      {{ error }}
      <button type="button" class="btn-close" (click)="clearMessages()"></button>
    </div>
  </div>

  <!-- Projects Content - Scrollable if needed -->
  <div class="projects-content flex-grow-1 p-3" style="overflow-y: auto;">
    <div *ngIf="loading" class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <!-- Projects Table -->
    <div *ngIf="!loading" class="table-responsive">
      <table class="table table-hover">
        <thead class="table-light">
          <tr>
            <th>Project Code</th>
            <th>Preferred Name</th>
            <th>State</th>
            <th>Locations</th>
            <th>Users</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let project of projects">
            <td>
              <strong class="text-primary">{{ project.code }}</strong>
            </td>
            <td>{{ project.preferredName || project.name }}</td>
            <td>
              <div class="d-flex flex-wrap gap-1">
                <span *ngFor="let state of project.states" class="badge bg-info">{{ state }}</span>
              </div>
            </td>
            <td>
              <span class="badge bg-secondary">{{ project.locationCount }}</span>
            </td>
            <td>
              <span class="badge bg-secondary">{{ project.userCount }}</span>
            </td>
            <td>
              <span class="badge" [class]="project.isActive ? 'bg-success' : 'bg-warning'">
                {{ project.isActive ? 'Active' : 'Inactive' }}
              </span>
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-primary" (click)="openLocationModal(project)" title="Manage Locations">
                  <i class="fas fa-map-marker-alt"></i>
                </button>
                <button class="btn btn-outline-secondary" (click)="openEditModal(project)" title="Edit Project">
                  <i class="fas fa-edit"></i>
                </button>
                <button *ngIf="project.isActive" class="btn btn-outline-warning" (click)="deactivateProject(project)" title="Deactivate">
                  <i class="fas fa-pause"></i>
                </button>
                <button *ngIf="!project.isActive" class="btn btn-outline-success" (click)="activateProject(project)" title="Activate">
                  <i class="fas fa-play"></i>
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="projects.length === 0">
            <td colspan="7" class="text-center py-4 text-muted">
              No projects found. <a href="#" (click)="openCreateModal(); $event.preventDefault()">Create your first project</a>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Create Project Modal - Tab Based, No Scroll -->
<div class="modal fade" [class.show]="showCreateModal" [style.display]="showCreateModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content h-75">
      <div class="modal-header">
        <h5 class="modal-title">Create New Project</h5>
        <button type="button" class="btn-close" (click)="closeModals()"></button>
      </div>

      <!-- Tab Navigation -->
      <div class="modal-body p-0 d-flex flex-column">
        <ul class="nav nav-tabs px-3 pt-3 mb-0" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" 
                    type="button">
              <i class="fas fa-info-circle me-2"></i>Project Details
              <i *ngIf="isTabValid(1)" class="fas fa-check text-success ms-2"></i>
            </button>
          </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content flex-grow-1 p-3" style="overflow-y: auto;">
          <!-- Project Details -->
          <div class="tab-pane fade show active">
            <div class="row g-3">
              <!-- SPV Name -->
              <div class="col-md-6">
                <label class="form-label">SPV Name *</label>
                <input 
                  type="text" 
                  class="form-control" 
                  [class.is-invalid]="hasValidationError('spvName')"
                  [(ngModel)]="createForm.spvName" 
                  name="spvName"
                  (input)="onSpvNameChange()"
                  placeholder="Enter SPV name"
                  autocomplete="off"
                  required
                />
                <div *ngIf="hasValidationError('spvName')" class="invalid-feedback d-block">
                  {{ getValidationError('spvName') }}
                </div>
              </div>

              <!-- Preferred Name -->
              <div class="col-md-6">
                <label class="form-label">Preferred Name <small class="text-muted">(Optional)</small></label>
                <input type="text" 
                       class="form-control" 
                       [(ngModel)]="createForm.preferredName" 
                       name="preferredName"
                       placeholder="Enter preferred project name">
              </div>

              <!-- States -->
              <div class="col-md-6">
                <label class="form-label">States *</label>
                <div class="dropdown w-100">
                  <input type="text" 
                         class="form-control" 
                         [class.is-invalid]="hasValidationError('states')"
                         [(ngModel)]="stateSearchTerm" 
                         name="stateSearch"
                         (input)="onStateInput($event)"
                         (focus)="toggleStateDropdown($event)"
                         placeholder="Type to search and select states"
                         autocomplete="off">
                  <ul class="dropdown-menu w-100" [class.show]="showStateDropdown" style="max-height: 200px; overflow-y: auto;">
                    <li *ngFor="let state of filteredStates">
                      <a class="dropdown-item d-flex justify-content-between align-items-center" 
                         href="#" 
                         (click)="toggleStateSelection(state); $event.preventDefault()"
                         [class.active]="isStateSelected(state)">
                        {{ state }}
                        <i *ngIf="isStateSelected(state)" class="fas fa-check text-success"></i>
                      </a>
                    </li>
                    <li *ngIf="filteredStates.length === 0" class="dropdown-item-text text-muted">
                      No matches found
                    </li>
                  </ul>
                </div>
                
                <!-- Selected States Display -->
                <div class="mt-2" *ngIf="createForm.states.length > 0">
                  <span *ngFor="let state of createForm.states" class="badge bg-primary me-2 mb-1">
                    {{ state }}
                    <button type="button" class="btn-close btn-close-white ms-2" 
                            (click)="removeState(state)" 
                            style="font-size: 0.7em;"></button>
                  </span>
                </div>
                
                <div *ngIf="hasValidationError('states')" class="invalid-feedback d-block">
                  {{ getValidationError('states') }}
                </div>
              </div>

              <!-- Project Code -->
              <div class="col-md-6">
                <label class="form-label">Project Code *</label>
                <input type="text" 
                       class="form-control text-uppercase" 
                       [class.is-invalid]="hasValidationError('code')"
                       [(ngModel)]="createForm.code" 
                       name="code"
                       (input)="onProjectCodeChange()"
                       placeholder="Auto-generated from SPV and State">
                <div *ngIf="hasValidationError('code')" class="invalid-feedback">
                  {{ getValidationError('code') }}
                </div>
              </div>

              <!-- Description -->
              <div class="col-12">
                <label class="form-label">Description <small class="text-muted">(Optional)</small></label>
                <textarea class="form-control" 
                          rows="3" 
                          [(ngModel)]="createForm.description" 
                          name="description"
                          placeholder="Enter project description"
                          maxlength="500"></textarea>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModals()">Cancel</button>
        <button type="button" class="btn btn-success" 
                [disabled]="!isTabValid(1) || loading" 
                (click)="createProject()">
          <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
          <i *ngIf="!loading" class="fas fa-save me-2"></i>Create Project
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Project Modal -->
<div class="modal fade" [class.show]="showEditModal" [style.display]="showEditModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Project</h5>
        <button type="button" class="btn-close" (click)="closeModals()"></button>
      </div>
      <div class="modal-body">
        <form *ngIf="selectedProject">
          <div class="mb-3">
            <label class="form-label">Project Code</label>
            <input type="text" class="form-control" [value]="selectedProject.code" readonly>
            <div class="form-text">Project code cannot be changed</div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">SPV Name</label>
            <input type="text" class="form-control" [value]="selectedProject.spvName" readonly>
            <div class="form-text">SPV name cannot be changed</div>
          </div>

          <div class="mb-3">
            <label class="form-label">Preferred Name</label>
            <input type="text" class="form-control" [(ngModel)]="editForm.preferredName" name="preferredName">
          </div>

          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" rows="3" [(ngModel)]="editForm.description" name="description"></textarea>
          </div>

          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" [(ngModel)]="editForm.isActive" name="isActive">
              <label class="form-check-label">Active</label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModals()">Cancel</button>
        <button type="button" class="btn btn-primary" [disabled]="loading" (click)="updateProject()">
          <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
          <i *ngIf="!loading" class="fas fa-save me-2"></i>Update Project
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Location Management Modal -->
<div class="modal fade" [class.show]="showLocationModal" [style.display]="showLocationModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content h-75">
      <div class="modal-header">
        <h5 class="modal-title">Manage Locations - {{ selectedProject?.name }}</h5>
        <button type="button" class="btn-close" (click)="closeModals()"></button>
      </div>

      <div class="modal-body p-0 d-flex flex-column">
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
          <h6 class="mb-0">Project Locations</h6>
          <button class="btn btn-primary btn-sm" (click)="openAddLocationModal()">
            <i class="fas fa-plus me-2"></i>Add Location
          </button>
        </div>
        
        <!-- Locations List -->
        <div class="flex-grow-1 p-3" style="overflow-y: auto;">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>Location Name</th>
                  <th>Type</th>
                  <th>Details</th>
                  <th>Assets</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let location of projectLocations">
                  <td>
                    <strong>{{ location.name }}</strong>
                  </td>
                  <td>
                    <span class="badge" [class]="location.plaza ? 'bg-info' : 'bg-secondary'">
                      {{ location.plaza ? 'Plaza' : 'Office' }}
                    </span>
                  </td>
                  <td>
                    <div class="small">
                      <div *ngIf="location.plaza"><strong>Plaza:</strong> {{ location.plaza }}</div>
                      <div *ngIf="location.office"><strong>Office:</strong> {{ location.office }}</div>
                      <div *ngIf="location.address"><strong>Address:</strong> {{ location.address }}</div>
                      <div><strong>Region:</strong> {{ location.region }}</div>
                      <div><strong>State:</strong> {{ location.state }}</div>
                    </div>
                  </td>
                  <td>
                    <span class="badge bg-secondary">{{ location.assetCount }}</span>
                  </td>
                  <td>
                    <span class="badge" [class]="location.isActive ? 'bg-success' : 'bg-warning'">
                      {{ location.isActive ? 'Active' : 'Inactive' }}
                    </span>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm" role="group">
                      <button class="btn btn-outline-secondary" (click)="editLocation(location)" title="Edit Location">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn btn-outline-danger" (click)="deleteLocation(location)" title="Delete Location">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                <tr *ngIf="projectLocations.length === 0 && !loading">
                  <td colspan="6" class="text-center text-muted py-4">
                    <i class="fas fa-map-marker-alt fa-2x mb-2 d-block"></i>
                    No locations found for this project.
                    <br>
                    <button class="btn btn-primary btn-sm mt-2" (click)="openAddLocationModal()">
                      <i class="fas fa-plus me-2"></i>Add First Location
                    </button>
                  </td>
                </tr>
                <tr *ngIf="loading">
                  <td colspan="6" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModals()">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Location Modal - Multi-tab for Office/Plaza -->
<div class="modal fade" [class.show]="showAddLocationModal" [style.display]="showAddLocationModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content" style="max-height: 85vh; display: flex; flex-direction: column;">
      <div class="modal-header" style="flex-shrink: 0;">
        <h5 class="modal-title">Add Location</h5>
        <button type="button" class="btn-close" (click)="closeAddLocationModal()"></button>
      </div>

      <div class="modal-body p-0 d-flex flex-column" style="flex: 1; min-height: 0; overflow: hidden;">
        <!-- Location Type Selection -->
        <div class="p-3 border-bottom" style="flex-shrink: 0;">
          <label class="form-label">Location Type *</label>
          <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="locationType" id="office" value="office" [(ngModel)]="locationForm.type">
            <label class="btn btn-outline-primary" for="office">
              <i class="fas fa-building me-2"></i>Office
            </label>
            
            <input type="radio" class="btn-check" name="locationType" id="plaza" value="plaza" [(ngModel)]="locationForm.type">
            <label class="btn btn-outline-primary" for="plaza">
              <i class="fas fa-road me-2"></i>Plaza
            </label>
          </div>
        </div>

        <!-- Office Form -->
        <div *ngIf="locationForm.type === 'office'" class="flex-grow-1 p-3" style="overflow-y: auto;">
          <h6 class="mb-3">Office Details</h6>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Office Name *</label>
              <input type="text" 
                     class="form-control" 
                     [(ngModel)]="locationForm.name" 
                     name="officeName"
                     placeholder="Enter office name"
                     autocomplete="off">
              <div class="form-text">Enter the office name</div>
            </div>
            
            <div class="col-md-6">
              <label class="form-label">District *</label>
              <div class="dropdown w-100">
                <input type="text" 
                       class="form-control" 
                       [(ngModel)]="locationForm.district" 
                       name="district"
                       (input)="onDistrictInput($event)"
                       (focus)="showDistrictDropdown = true"
                       placeholder="Type or select district"
                       autocomplete="off">
                <ul class="dropdown-menu w-100" [class.show]="showDistrictDropdown" style="max-height: 200px; overflow-y: auto;">
                  <li *ngFor="let district of filteredDistricts">
                    <a class="dropdown-item" href="#" (click)="selectDistrict(district); $event.preventDefault()">{{ district }}</a>
                  </li>
                </ul>
              </div>
              <div class="form-text">Districts filtered by selected states</div>
            </div>
          </div>
        </div>

        <!-- Plaza Form with Tabs -->
        <div *ngIf="locationForm.type === 'plaza'" class="d-flex flex-column" style="flex: 1; min-height: 0;">
          <!-- Plaza Sub-tabs -->
          <ul class="nav nav-tabs px-3 pt-3 mb-0" role="tablist" style="flex-shrink: 0;">
            <li class="nav-item" role="presentation">
              <button class="nav-link" 
                      [class.active]="plazaTab === 1"
                      (click)="navigateToPlazaTab(1)"
                      type="button">
                <i class="fas fa-info-circle me-2"></i>Basic Details
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" 
                      [class.active]="plazaTab === 2"
                      [class.disabled]="!canNavigateToPlazaTab(2)"
                      [disabled]="!canNavigateToPlazaTab(2)"
                      (click)="navigateToPlazaTab(2)"
                      type="button"
                      [title]="!canNavigateToPlazaTab(2) ? 'Complete Basic Details first' : ''">
                <i class="fas fa-road me-2"></i>Lane Config
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" 
                      [class.active]="plazaTab === 3"
                      [class.disabled]="!canNavigateToPlazaTab(3)"
                      [disabled]="!canNavigateToPlazaTab(3)"
                      (click)="navigateToPlazaTab(3)"
                      type="button"
                      [title]="!canNavigateToPlazaTab(3) ? 'Complete previous tabs first' : ''">
                <i class="fas fa-map-marker-alt me-2"></i>Internal Locations
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" 
                      [class.active]="plazaTab === 4"
                      [class.disabled]="!canNavigateToPlazaTab(4)"
                      [disabled]="!canNavigateToPlazaTab(4)"
                      (click)="navigateToPlazaTab(4)"
                      type="button"
                      [title]="!canNavigateToPlazaTab(4) ? 'Complete previous tabs first' : ''">
                <i class="fas fa-check me-2"></i>Review
              </button>
            </li>
          </ul>

          <!-- Plaza Tab Content -->
          <div class="tab-content p-3" style="flex: 1; overflow-y: auto; min-height: 0;">
            <!-- Plaza Tab 1: Basic Details -->
            <div class="tab-pane fade" [class.show]="plazaTab === 1" [class.active]="plazaTab === 1">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Plaza Name *</label>
                  <input type="text" 
                         class="form-control" 
                         [(ngModel)]="locationForm.name" 
                         name="plazaName"
                         placeholder="Enter plaza name"
                         autocomplete="off">
                </div>
                
                <div class="col-md-6">
                  <label class="form-label">Plaza Code *</label>
                  <input type="text" 
                         class="form-control text-uppercase" 
                         [(ngModel)]="locationForm.plazaCode" 
                         name="plazaCode"
                         (input)="onPlazaCodeChange()"
                         placeholder="Enter plaza code">
                </div>

                <div class="col-md-6">
                  <label class="form-label">Government Code *</label>
                  <input type="text" 
                         class="form-control text-uppercase" 
                         [(ngModel)]="locationForm.governmentCode" 
                         name="governmentCode"
                         (input)="onGovCodeInput($event)"
                         placeholder="Enter government code"
                         autocomplete="off">
                </div>

                <div class="col-md-6">
                  <label class="form-label">Chainage Number *</label>
                  <input type="text" 
                         class="form-control" 
                         [(ngModel)]="locationForm.chainageNumber" 
                         name="chainageNumber"
                         (input)="onChainageInput($event)"
                         placeholder="000.000"
                         maxlength="7">
                </div>

                <div class="col-md-6">
                  <label class="form-label">Latitude *</label>
                  <input type="number" 
                         class="form-control" 
                         [(ngModel)]="locationForm.latitude" 
                         name="latitude"
                         min="-90" 
                         max="90" 
                         step="0.000001"
                         placeholder="-90 to 90">
                </div>

                <div class="col-md-6">
                  <label class="form-label">Longitude *</label>
                  <input type="number" 
                         class="form-control" 
                         [(ngModel)]="locationForm.longitude" 
                         name="longitude"
                         min="-180" 
                         max="180" 
                         step="0.000001"
                         placeholder="-180 to 180">
                </div>
              </div>
            </div>

            <!-- Plaza Tab 2: Lane Configuration -->
            <div class="tab-pane fade" [class.show]="plazaTab === 2" [class.active]="plazaTab === 2">
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">Number of Lanes *</label>
                  <input type="number" 
                         class="form-control" 
                         [(ngModel)]="locationForm.numberOfLanes" 
                         name="numberOfLanes"
                         (input)="generateLanes()"
                         min="1"
                         max="20"
                         step="1"
                         placeholder="Enter number of lanes">
                  <div class="form-text">Enter 1-20 lanes</div>
                </div>
              </div>
              
              <!-- Lane Tabs -->
              <div *ngIf="locationForm.numberOfLanes" class="mt-4">
                <ul class="nav nav-pills nav-fill">
                  <li class="nav-item" *ngFor="let lane of generatedLanes; let i = index">
                    <button class="nav-link" 
                            [class.active]="selectedLane === i"
                            (click)="selectedLane = i"
                            type="button">
                      Lane {{ i + 1 }}
                    </button>
                  </li>
                </ul>
                
                <div class="mt-3 p-3 border rounded">
                  <h6>Lane {{ selectedLane + 1 }} Configuration</h6>
                  <p class="text-muted">Lane-specific configuration will be added here in future updates.</p>
                </div>
              </div>
            </div>

            <!-- Plaza Tab 3: Internal Locations -->
            <div class="tab-pane fade" [class.show]="plazaTab === 3" [class.active]="plazaTab === 3">
              <label class="form-label">Internal Locations *</label>
              <div class="form-text mb-3">Select at least one internal location</div>
              <div class="row g-2">
                <div class="col-md-4" *ngFor="let location of internalLocationOptions">
                  <div class="form-check">
                    <input class="form-check-input" 
                           type="checkbox" 
                           [value]="location" 
                           [checked]="locationForm.internalLocations?.includes(location)"
                           (change)="toggleInternalLocation(location, $event)"
                           [id]="getLocationId(location)">
                    <label class="form-check-label" [for]="getLocationId(location)">
                      {{ location }}
                    </label>
                  </div>
                </div>
              </div>
              
              <!-- Custom Location Input -->
              <div class="mt-3">
                <label class="form-label">Add Custom Location</label>
                <div class="input-group">
                  <input type="text" 
                         class="form-control" 
                         [(ngModel)]="customLocation" 
                         name="customLocation"
                         placeholder="Enter custom location name">
                  <button class="btn btn-outline-secondary" 
                          type="button" 
                          (click)="addCustomLocation()"
                          [disabled]="!customLocation || !customLocation.trim()">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- Plaza Tab 4: Review -->
            <div class="tab-pane fade" [class.show]="plazaTab === 4" [class.active]="plazaTab === 4">
              <h6>Review Plaza Configuration</h6>
              <div class="row g-3">
                <div class="col-md-6">
                  <strong>Plaza Name:</strong> {{ locationForm.name || 'Not set' }}
                </div>
                <div class="col-md-6">
                  <strong>Plaza Code:</strong> {{ locationForm.plazaCode || 'Not set' }}
                </div>
                <div class="col-md-6">
                  <strong>Government Code:</strong> {{ locationForm.governmentCode || 'Not set' }}
                </div>
                <div class="col-md-6">
                  <strong>Chainage:</strong> {{ locationForm.chainageNumber || 'Not set' }}
                </div>
                <div class="col-md-6">
                  <strong>Coordinates:</strong> {{ locationForm.latitude || 'Not set' }}, {{ locationForm.longitude || 'Not set' }}
                </div>
                <div class="col-md-6">
                  <strong>Lanes:</strong> {{ locationForm.numberOfLanes || 'Not set' }}
                </div>
                <div class="col-12">
                  <strong>Internal Locations:</strong>
                  <div class="mt-1">
                    <span *ngFor="let loc of locationForm.internalLocations; let last = last" class="badge bg-secondary me-1">
                      {{ loc }}
                    </span>
                    <span *ngIf="!locationForm.internalLocations?.length" class="text-muted">None selected</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer" style="flex-shrink: 0; border-top: 1px solid #dee2e6;">
        <button type="button" class="btn btn-secondary" (click)="closeAddLocationModal()">Cancel</button>
        
        <!-- Validation Message -->
        <div *ngIf="!isLocationFormValid()" class="text-danger me-auto">
          <small><i class="fas fa-exclamation-triangle me-1"></i>{{ getLocationValidationMessage() }}</small>
        </div>
        
        <button *ngIf="locationForm.type === 'plaza' && plazaTab > 1" 
                type="button" 
                class="btn btn-outline-primary" 
                (click)="plazaTab = plazaTab - 1">
          <i class="fas fa-arrow-left me-2"></i>Previous
        </button>
        <button *ngIf="locationForm.type === 'plaza' && plazaTab < 4" 
                type="button" 
                class="btn btn-primary" 
                [disabled]="!canMoveToNextPlazaTab()"
                (click)="plazaTab = plazaTab + 1"
                [title]="!canMoveToNextPlazaTab() ? 'Please fill all required fields' : 'Next'">
          Next<i class="fas fa-arrow-right ms-2"></i>
        </button>
        <button type="button" 
                class="btn btn-success" 
                [disabled]="!isLocationFormValid() || loading"
                (click)="saveLocation()"
                title="{{ !isLocationFormValid() ? getLocationValidationMessage() : 'Save Location' }}">
          <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
          <i *ngIf="!loading" class="fas fa-save me-2"></i>Save Location
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Location Modal -->
<div class="modal fade" [class.show]="showEditLocationModal" [style.display]="showEditLocationModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-edit me-2"></i>Edit Location
        </h5>
        <button type="button" class="btn-close" (click)="closeEditLocationModal()"></button>
      </div>

      <div class="modal-body">
        <!-- Success/Error Messages -->
        <div *ngIf="success" class="alert alert-success alert-dismissible fade show">
          {{ success }}
          <button type="button" class="btn-close" (click)="clearMessages()"></button>
        </div>
        <div *ngIf="error" class="alert alert-danger alert-dismissible fade show">
          {{ error }}
          <button type="button" class="btn-close" (click)="clearMessages()"></button>
        </div>

        <form>
          <div class="mb-3">
            <label for="editLocationName" class="form-label">Location Name *</label>
            <input 
              type="text" 
              class="form-control" 
              id="editLocationName"
              [(ngModel)]="editLocationForm.name"
              name="name"
              required
            />
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editLocationRegion" class="form-label">Region</label>
              <input 
                type="text" 
                class="form-control" 
                id="editLocationRegion"
                [(ngModel)]="editLocationForm.region"
                name="region"
              />
            </div>

            <div class="col-md-6 mb-3">
              <label for="editLocationState" class="form-label">State</label>
              <input 
                type="text" 
                class="form-control" 
                id="editLocationState"
                [(ngModel)]="editLocationForm.state"
                name="state"
              />
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editLocationPlaza" class="form-label">Plaza</label>
              <input 
                type="text" 
                class="form-control" 
                id="editLocationPlaza"
                [(ngModel)]="editLocationForm.plaza"
                name="plaza"
              />
            </div>

            <div class="col-md-6 mb-3">
              <label for="editLocationOffice" class="form-label">Office</label>
              <input 
                type="text" 
                class="form-control" 
                id="editLocationOffice"
                [(ngModel)]="editLocationForm.office"
                name="office"
              />
            </div>
          </div>

          <div class="mb-3">
            <label for="editLocationAddress" class="form-label">Address</label>
            <textarea 
              class="form-control" 
              id="editLocationAddress"
              [(ngModel)]="editLocationForm.address"
              name="address"
              rows="2"
            ></textarea>
          </div>

          <div class="form-check mb-3">
            <input 
              type="checkbox" 
              class="form-check-input" 
              id="editLocationActive"
              [(ngModel)]="editLocationForm.isActive"
              name="isActive"
            />
            <label class="form-check-label" for="editLocationActive">
              Active
            </label>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeEditLocationModal()">
          Cancel
        </button>
        <button 
          type="button" 
          class="btn btn-primary" 
          (click)="updateLocation()"
          [disabled]="loading || !editLocationForm.name"
        >
          <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
          <i *ngIf="!loading" class="fas fa-save me-2"></i>
          Save Changes
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div *ngIf="showCreateModal || showEditModal || showLocationModal || showAddLocationModal || showEditLocationModal" 
     class="modal-backdrop fade show" 
     (click)="closeModals()"></div>